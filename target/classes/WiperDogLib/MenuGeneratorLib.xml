<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>WiperDogLib</web>
  <name>MenuGeneratorLib</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>WiperDogLib.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1385974987000</creationDate>
  <date>1388111211000</date>
  <contentUpdateDate>1388111211000</contentUpdateDate>
  <version>1.1</version>
  <title>MenuGeneratorLib</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>WiperDogLib.MenuGeneratorLib</name>
    <number>0</number>
    <className>XWiki.XWikiRights</className>
    <guid>9820bbf5-a1f2-4472-a371-7eb49b1e1209</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <levels>view,comment</levels>
    </property>
    <property>
      <users>XWiki.XWikiGuest</users>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>WiperDogLib.MenuGeneratorLib</name>
    <number>1</number>
    <className>XWiki.XWikiRights</className>
    <guid>ed1cd444-f2de-40ef-afc4-40ac87efa454</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAdminGroup</groups>
    </property>
    <property>
      <levels>view,comment,edit,delete</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>WiperDogLib.MenuGeneratorLib</name>
    <number>2</number>
    <className>XWiki.XWikiRights</className>
    <guid>5e04e8ca-5a2f-40fc-a5b8-9586f85c9a42</guid>
    <property>
      <allow>0</allow>
    </property>
    <property>
      <levels>delete,edit</levels>
    </property>
    <property>
      <users>XWiki.XWikiGuest</users>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>WiperDogLib.MenuGeneratorLib</name>
    <number>3</number>
    <className>XWiki.XWikiRights</className>
    <guid>428cc7b9-cfe3-467a-90dc-d237e25656a0</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>view,comment</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>WiperDogLib.MenuGeneratorLib</name>
    <number>4</number>
    <className>XWiki.XWikiRights</className>
    <guid>07e4f381-cba6-4b9e-9698-1193658da63a</guid>
    <property>
      <allow>0</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>edit,delete</levels>
    </property>
  </object>
  <content>{{include document="WiperDogLib.MongoDBConnection"/}}
{{groovy}}
import com.gmongo.GMongo
import org.xwiki.context.*

class MenuGeneratorSupport {
/**
 * Main function, used for create menu 
 * Input treeMap: Menu tree map (not leaf)
 *       mapCollection: Map of collections, Item of map has key is a job group and value is list job which is applied for that group
 * Output: Source menu in HTML mode
 **/
def getMenuGenStr(treeMap, mapCollection) {
    def result = '{{html wiki = "true" clean="false"}}'
    result += "&lt;div id='nav'&gt;"
    result += "&lt;a href=\"javascript:ddtreemenu.flatten('treemenu2', 'expand')\"&gt;Expand All&lt;/a&gt; ||&lt;a href=\"javascript:ddtreemenu.flatten('treemenu2', 'contact')\"&gt;Collapse All&lt;/a&gt; "

    result += getMenuItemsStr(treeMap, mapCollection)

    result += "&lt;/div&gt;"
    result += "{{/html}}"
    return result
}

/**
 * Recursively function, used for gen tree menu data 
 * Input treeItem: root tree map of menu (not leaf)
 *       mapCollection: Map of collections, Item of map has key is a job group and value is list job which is applied for that group
 *       parentList: used for recursively to canculate key if data if leaf
 * Output: If data is leaf, create key of group data, get list of job which is applied for group from mapCollection and create menu Item
 *         If data isn't leaf, create node and call recursively function with sub data
 **/
def getMenuItemsStr(treeItem, mapCollection, parentList = []) {     
     def ul_open = false
     def result = ""
     def parentStr = ""
     def parentLstforChild = []

     //If data isn't leaf, create node and call recursively function with sub data
     if (treeItem instanceof Map) {
         result += "&lt;ul id='treemenu2' class='treeview'&gt;"
         treeItem.each{itemKey, itemVal -&gt; 
             parentList.each{parentListItem-&gt;
                 parentLstforChild.add(parentListItem)
             }
             parentLstforChild.add(itemKey)
	     result += "&lt;li&gt;"+ itemKey
             result += getMenuItemsStr(itemVal, mapCollection, parentLstforChild)
             result +="&lt;/li&gt;"
             parentLstforChild = []
         } 
         result += "&lt;/ul&gt;"
     }
     
     //If data is leaf, create key of group data, get list of job which is applied for group from mapCollection and create menu Item
     if (treeItem instanceof List) {
         result += "&lt;ul&gt;"
         parentList.each{parentItem -&gt; 
              if (parentStr != ""){
                  parentStr += "."
              }
              parentStr += parentItem
         }
         if (mapCollection[parentStr] != null) {
             mapCollection[parentStr].each {item-&gt;
                 result += "&lt;li&gt;&lt;a&gt;" + item +"&lt;/a&gt;&lt;/li&gt;"
             }
         }
         result += "&lt;/ul&gt;"
     }
     return result
}

/**
 * Get data from mongoDB and create map. Item of map has key is job group and value is list job which is applied for that group
 * Input listJobGroup: used for check Others group
 * Input services: services API of XWiki for saving data to use later
 **/
def getCollections(listJobGroup, services) {
	try{
	    def tmp = new ArrayList&lt;String&gt;();
	    def tmpSize
	    def mapJobIstIid = [:]
	    def mapGroupJob = [:]

	    //The variable is used to save data for IstIid in  MonitoringData screen
	    def ec = services.component.getInstance(Execution.class).getContext()

	    def mongoDBConn = new MongoDBConnection()
	    def conllections = mongoDBConn.db.getCollectionNames()
	    
	    def itemGroup
	    def itemJob
	    def itemIst
	    conllections.each{
		tmp = it.split("\\.")
	        tmpSize = tmp.size()
	        
	        if (tmpSize &gt;= 2) {
	            itemIst = tmp[tmpSize - 1]
	            itemJob = it - ("." + itemIst)
	            itemGroup = it - ("." + tmp[tmpSize - 2] + "." + tmp[tmpSize - 1])
	 
	            //If this group is not contains in listJobGroup, put in Others group
	            if (tmpSize &gt;= 3 &amp;&amp; !listJobGroup.contains(itemGroup)) {
	                 itemGroup = itemGroup - tmp[tmpSize - 3] + "Others"
	            }

	            //Init
	            if(mapGroupJob[itemGroup] == null) {
	                mapGroupJob[itemGroup] = []
	            }
	            //Add to list if not contains
	            if (!mapGroupJob[itemGroup].contains(itemJob)) {
	                mapGroupJob[itemGroup].add(itemJob)
	            }
	            
	            //Init
	            if(mapJobIstIid[itemJob] == null) {
	                mapJobIstIid[itemJob] = [] 
	            }
	            //Add to list
	            mapJobIstIid[itemJob].add(itemIst)
	        }
	    }
	    ec.setProperty("mapJobIstIid", mapJobIstIid)
	    return mapGroupJob
	} catch (Exception ex){
	    throw ex
	} finally {
	    if(mongoDBConn != null){
	        mongoDBConn.closeConnection()
	    }
	}
}

/**
 * Create list job group from declared treeMap
 * Input treeItem: root tree map of menu (not leaf)
 *       parentList: used for recursively to canculate parent key if data is the last node before leaf
 * Output: if data is the last node before leaf, add as item of final list
 **/
def getListJobGroup(groupItems, parentList = []) {
    def returnList = []
    def parentLstforChild = []
    def parentStr = ""
    def chilData

    if (groupItems instanceof Map) {
        groupItems.each{itemKey, itemVal -&gt; 
             parentList.each{parentListItem-&gt;
                 parentLstforChild.add(parentListItem)
             }
             parentLstforChild.add(itemKey)
             chilData = getListJobGroup(itemVal, parentLstforChild)
             chilData.each{
                  returnList.add(it)
             }
             parentLstforChild = []
        }
    }

    if (groupItems instanceof List) {
        parentList.each{parentItem -&gt; 
            if (parentStr != ""){
                parentStr += "."
            }
            parentStr += parentItem
        }
        returnList.add(parentStr)
    }
    return returnList
}
}
{{/groovy}}</content>
</xwikidoc>
