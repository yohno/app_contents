<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>WiperDogLib</web>
<name>ConsoleService</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent>WiperDogLib.WebHome</parent>
<creator>XWiki.nguyenvannghia</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1380879465000</creationDate>
<date>1382323627000</date>
<contentUpdateDate>1382323624000</contentUpdateDate>
<version>1.1</version>
<title>ConsoleService</title>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Imported from XAR</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.1</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<picker>1</picker>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<picker>1</picker>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>WiperDogLib.ConsoleService</name>
<number>0</number>
<className>XWiki.XWikiRights</className>
<guid>34ccc54a-bb52-47c6-91dc-2d51b30e5b45</guid>
<property>
<allow>1</allow>
</property>
<property>
<groups>XWiki.XWikiAdminGroup</groups>
</property>
<property>
<levels>view,comment,edit,delete</levels>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<picker>1</picker>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<picker>1</picker>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>WiperDogLib.ConsoleService</name>
<number>2</number>
<className>XWiki.XWikiRights</className>
<guid>84ab526e-39d3-45a7-9566-1cf0724840a4</guid>
<property>
<allow>0</allow>
</property>
<property>
<groups>XWiki.XWikiAllGroup</groups>
</property>
<property>
<levels>delete,edit</levels>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<picker>1</picker>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<picker>1</picker>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>WiperDogLib.ConsoleService</name>
<number>3</number>
<className>XWiki.XWikiRights</className>
<guid>b3c8e3a4-bc89-4b48-b2d0-e68a261020b8</guid>
<property>
<allow>1</allow>
</property>
<property>
<groups>XWiki.XWikiAllGroup</groups>
</property>
<property>
<levels>comment,view</levels>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<picker>1</picker>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<picker>1</picker>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>WiperDogLib.ConsoleService</name>
<number>4</number>
<className>XWiki.XWikiRights</className>
<guid>c7be2c34-979b-4912-b3f4-f48ff5403295</guid>
<property>
<allow>1</allow>
</property>
<property>
<levels>view,comment</levels>
</property>
<property>
<users>XWiki.XWikiGuest</users>
</property>
</object>
<object>
<class>
<name>XWiki.XWikiRights</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<allow>
<defaultValue>1</defaultValue>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>allow</displayType>
<name>allow</name>
<number>4</number>
<prettyName>Allow/Deny</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</allow>
<groups>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>groups</name>
<number>1</number>
<picker>1</picker>
<prettyName>Groups</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
</groups>
<levels>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>1</multiSelect>
<name>levels</name>
<number>2</number>
<prettyName>Levels</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>3</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
</levels>
<users>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>users</name>
<number>3</number>
<picker>1</picker>
<prettyName>Users</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
</users>
</class>
<name>WiperDogLib.ConsoleService</name>
<number>5</number>
<className>XWiki.XWikiRights</className>
<guid>f160359a-cac2-4d63-8127-d4b034c2b749</guid>
<property>
<allow>0</allow>
</property>
<property>
<levels>edit,delete</levels>
</property>
<property>
<users>XWiki.XWikiGuest</users>
</property>
</object>
<content>{{include document='WiperDog.GetServletClass'/}}
{{groovy}}
        import groovy.json.*
try{
        def osName = System.getProperty('os.name')
        if(osName != null &amp;&amp; osName.toLowerCase().indexOf('win') ==-1){
		        def wiperdog_path = '/home/wiperdog'
		        Properties props = System.getProperties();
		        def xwiki_dir = props.getProperty('user.dir');
			def decidedWiperdog_path
			File f = new File(xwiki_dir +"/webapps/xwiki/resources/conf.params")
			if(f.exists()){
				def shell = new GroovyShell()
				params = shell.evaluate(f)
				if(params['wiperdog_path'] != null){
					decidedWiperdog_path = params['wiperdog_path']
				}else{
					decidedWiperdog_path = wiperdog_path
				}
			}else{
				decidedWiperdog_path = wiperdog_path
			}

		        if(request.xpage == "plain") {
			   response.setContentType('text/html')
		        }
			def cmd = request.getParameter("cmd");
		        def errorStr = ""
		   	if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("start")){
		            def command = '/bin/sh ' + decidedWiperdog_path + '/bin/wiperdog start '  	   
		            def proc = command.execute()
			    proc.waitFor()
		            errorStr = proc.err.text
		            if(errorStr != null &amp;&amp; errorStr  != '')
		                println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Output: ${proc.in.text}&lt;/p&gt;"
                            println command 
			}else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("stop")){
		            def command = '/bin/sh ' + decidedWiperdog_path + '/bin/wiperdog stop '  	   
		            def proc = command.execute()
			    proc.waitFor()
		            errorStr = proc.err.text
		            if(errorStr != null &amp;&amp; errorStr  != '')
		                println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Output: ${proc.in.text}&lt;/p&gt;"
		        }else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("status")){
		            def command = ''
		            def proc
		            command = '/bin/sh ' + decidedWiperdog_path + '/bin/wiperdog status '
		            proc = command.execute()
		            proc.waitFor()
		            errorStr = proc.err.text
		            if(errorStr != null &amp;&amp; errorStr  != '')
		                println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Checking status: ${proc.in.text}&lt;/p&gt;"
		            def paramObj = new GetServlet()
		            def consoleServlet = paramObj.getParam('console')
		            command = 'curl -Is  ' + consoleServlet 

		            proc = command.execute()
			    proc.waitFor()
		            errorStr = proc.err.text
		            if(errorStr != null &amp;&amp; errorStr  != '')
		                println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Checking echo servlet: ${proc.in.text}&lt;/p&gt;"
		        }else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("hostinfo")){
		            def hostInfo = [:]
		            def command = ''
		            def proc
		            command = 'hostname '
		            proc = command.execute()
		            proc.waitFor()            
		            hostInfo['hostName'] = proc.in.text
		            
			        command = 'ifconfig eth0 '
		            proc = command.execute()            
		            proc.waitFor()
		            def tmpHostIp = proc.in.text
		            def hostIp = ''
		            if(tmpHostIp != null &amp;&amp; tmpHostIp.indexOf("inet addr:") != -1){
		            	hostIp = tmpHostIp.split("inet addr:")[1].split(" ")[0]
		            }
		            hostInfo['hostIp'] = hostIp
		            
		            command = 'cat ' + decidedWiperdog_path +'/etc/system.properties'
		            proc = command.execute()            
		            proc.waitFor()
		            def tmpHostPort = proc.in.text
		            def hostPort = ""            
		            if(tmpHostPort != null &amp;&amp; tmpHostPort.indexOf("jetty.port=") != -1){
		            	hostPort = tmpHostPort.split("jetty.port=")[1].split("\n")[0]
		            }
		            hostInfo['hostPort'] = hostPort
		            def builder = new JsonBuilder(hostInfo)
		            println builder.toPrettyString()
		        }else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("hostport")){
		            def command = ''
		            def proc
		            command = 'cat ' + decidedWiperdog_path +'/etc/system.properties'
		            proc = command.execute()
		            proc.waitFor()            
		            println proc.in.text.split("jetty.port=")[1].split("\n")[0]
		        }
		}else{//osName
			//-- Set wiperdog PATH
		        def wiperdog_path = 'E:\\wiperdog'
		        Properties props = System.getProperties();
		        def xwiki_dir = props.getProperty('user.dir');
			def decidedWiperdog_path
			File f = new File(xwiki_dir +"/webapps/xwiki/resources/conf.params")
			if(f.exists()){
				def shell = new GroovyShell()
				params = shell.evaluate(f)
				if(params['wiperdog_path'] != null){
					decidedWiperdog_path = params['wiperdog_path']
				}else{
					decidedWiperdog_path = wiperdog_path
				}
			}else{
				decidedWiperdog_path = wiperdog_path
			}
			//-- END 
			//-- Set request content type
		        if(request.xpage == "plain") {
			   response.setContentType('text/html')
		        }
		    //-- END
		    
			def cmd = request.getParameter("cmd");
		    def errorStr = ""
		   	if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("start")){
		        def command = 'net start wiperdog'  	   
		        def proc = command.execute()
			    proc.waitFor()
		        errorStr = proc.err.text
		        if(errorStr != null &amp;&amp; errorStr  != '')
		            println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Output: ${proc.in.text}&lt;/p&gt;"
			}else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("stop")){
		        def command = 'net stop wiperdog'  	   
		        def proc = command.execute()
			    proc.waitFor()
		        errorStr = proc.err.text
		        if(errorStr != null &amp;&amp; errorStr  != '')
		            println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Output: ${proc.in.text}&lt;/p&gt;"
		    }else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("status")){
		        def command = ''
		        def proc
		        command = 'sc query wiperdog'
		        proc = command.execute()
		        proc.waitFor()
		        errorStr = proc.err.text
		        if(errorStr != null &amp;&amp; errorStr  != '')
		            println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Checking status: ${proc.in.text}&lt;/p&gt;"
		        def paramObj = new GetServlet()
		        def consoleServlet = paramObj.getParam('console')
		        command = wiperdog_path + '\\service\\curl\\curl -Is  ' + consoleServlet 
		        proc = command.execute()
			    proc.waitFor()
		        errorStr = proc.err.text
		        if(errorStr != null &amp;&amp; errorStr  != '')
		            println "&lt;p&gt; Information: ${errorStr}&lt;/p&gt;" 
			    println "&lt;p&gt; Checking echo servlet: ${proc.in.text}&lt;/p&gt;"
		    }else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("hostinfo")){
		            def hostInfo = [:]
		            def command = ''
		            def proc
		            command = 'hostname '
		            proc = command.execute()
		            proc.waitFor()
		            def hostName = proc.in.text
		            def newHostName = hostName.replace("\r", "")
		            hostName = newHostName.replace("\n","")
		            hostInfo['hostName'] = hostName

		            /*command = 'ipconfig '
			    proc = command.execute()
		            proc.waitFor()
		            def tmpHostIp = proc.in.text
		            def hostIp = ''
		            if(tmpHostIp != null &amp;&amp; tmpHostIp.indexOf("Local Area Connection") != -1){
		            	hostIp = tmpHostIp.split("Local Area Connection")[1].split("IP Address:")[1].split("\r\n")[0].trim()
		            }*/
		            hostInfo['hostIp'] = "127.0.0.1"
		            	
		            //-- Get Jetty port from wiperdog properties
		            Properties jettyProps = new Properties()
			    File propsFile = new File(decidedWiperdog_path +'/etc/system.properties')
			    jettyProps.load(propsFile.newDataInputStream())
		            def hostPort = jettyProps.getProperty('jetty.port')
		            hostInfo['hostPort'] = hostPort
		            def builder = new JsonBuilder(hostInfo)
		            println builder.toPrettyString()
		    }else if(cmd != null &amp;&amp; !cmd.equals("") &amp;&amp; cmd.equals("hostport")){
		            //-- Get Jetty port from wiperdog properties
		            Properties jettyProps = new Properties()
			    File propsFile = new File(decidedWiperdog_path +'/etc/system.properties')
			    jettyProps.load(propsFile.newDataInputStream())
		            def hostPort = jettyProps.getProperty('jetty.port')
		            println hostPort
		    }
		}
}catch(Exception ex){
println ex
}
{{/groovy}}</content></xwikidoc>
